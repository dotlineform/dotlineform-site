<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% if page.title and page.title != site.title %}{{ page.title }} | {{ site.title }}{% else %}{{ site.title }}{% endif %}</title>

  {% if page.description %}
  <meta name="description" content="{{ page.description | escape }}">
  {% endif %}

  <script>
    (function () {
      try {
        var t = localStorage.getItem('theme');
        document.documentElement.setAttribute('data-theme', (t === 'light' || t === 'dark') ? t : 'auto');
      } catch (e) {
        document.documentElement.setAttribute('data-theme', 'auto');
      }
    })();
  </script>

  <link rel="stylesheet" href="{{ '/assets/css/main.css' | relative_url }}">
</head>
<body class="{{ page.section | default: page.collection | default: 'page' }}">
  <header class="site-header">
    <div class="container">
      <div class="site-title">
        <a href="{{ '/' | relative_url }}">{{ site.title }}</a>
      </div>
      <nav class="site-nav" aria-label="Primary">
        {%- assign u = page.url | default: "" -%}
        {% assign u_series = u | slice: 0, 8 %}
        {% assign u_themes = u | slice: 0, 8 %}
        {% assign u_moments = u | slice: 0, 9 %}
        {% assign u_research = u | slice: 0, 10 %}

        {%- assign is_series_index = false -%}
        {%- assign is_series_active = false -%}
        {%- if u == '/series/' -%}{%- assign is_series_index = true -%}{%- endif -%}
        {%- if page.collection == 'series' or u_series == '/series/' -%}{%- assign is_series_active = true -%}{%- endif -%}

        {%- assign is_themes_index = false -%}
        {%- assign is_themes_active = false -%}
        {%- if u == '/themes/' -%}{%- assign is_themes_index = true -%}{%- endif -%}
        {%- if page.collection == 'themes' or u_themes == '/themes/' -%}{%- assign is_themes_active = true -%}{%- endif -%}

        {%- assign is_moments_index = false -%}
        {%- assign is_moments_active = false -%}
        {%- if u == '/moments/' -%}{%- assign is_moments_index = true -%}{%- endif -%}
        {%- if page.collection == 'moments' or u_moments == '/moments/' -%}{%- assign is_moments_active = true -%}{%- endif -%}

        {%- assign is_research_index = false -%}
        {%- assign is_research_active = false -%}
        {%- if u == '/research/' -%}{%- assign is_research_index = true -%}{%- endif -%}
        {%- if page.collection == 'research' or u_research == '/research/' -%}{%- assign is_research_active = true -%}{%- endif -%}

        <!-- series -->
        {% if is_series_index %}
          <span class="nav-item nav-item--overflow is-active" aria-current="page">works</span>
        {% elsif is_series_active %}
          <a class="nav-item nav-item--overflow is-active" href="{{ '/series/' | relative_url }}" aria-current="page">works</a>
        {% else %}
          <a class="nav-item nav-item--overflow" href="{{ '/series/' | relative_url }}">works</a>
        {% endif %}

        <!-- themes -->
        {% if is_themes_index %}
          <span class="nav-item nav-item--overflow is-active" aria-current="page">themes</span>
        {% elsif is_themes_active %}
          <a class="nav-item nav-item--overflow is-active" href="{{ '/themes/' | relative_url }}" aria-current="page">themes</a>
        {% else %}
          <a class="nav-item nav-item--overflow" href="{{ '/themes/' | relative_url }}">themes</a>
        {% endif %}

         <!-- more (mobile overflow) -->
        {%- assign more_active = false -%}
        {%- if is_series_active or is_series_index or is_themes_active or is_themes_index or is_moments_active or is_moments_index or is_research_active or is_research_index -%}
          {%- assign more_active = true -%}
        {%- endif -%}
        <div class="nav-more" data-nav-more>
          <button class="nav-item nav-more__summary{% if more_active %} is-active{% endif %}" type="button" aria-haspopup="menu" aria-expanded="false" aria-label="More">
            &#9776;
          </button>
          <div class="nav-more__panel" role="menu" hidden>
            {% if is_series_index %}
              <span class="nav-more__item is-active" aria-current="page">works</span>
            {% elsif is_series_active %}
              <a class="nav-more__item is-active" href="{{ '/series/' | relative_url }}" aria-current="page">works</a>
            {% else %}
              <a class="nav-more__item" href="{{ '/series/' | relative_url }}">works</a>
            {% endif %}
            {% if is_themes_index %}
              <span class="nav-more__item is-active" aria-current="page">themes</span>
            {% elsif is_themes_active %}
              <a class="nav-more__item is-active" href="{{ '/themes/' | relative_url }}" aria-current="page">themes</a>
            {% else %}
              <a class="nav-more__item" href="{{ '/themes/' | relative_url }}">themes</a>
            {% endif %}
            {% if is_moments_index %}
              <span class="nav-more__item is-active" aria-current="page">moments</span>
            {% elsif is_moments_active %}
              <a class="nav-more__item is-active" href="{{ '/moments/' | relative_url }}" aria-current="page">moments</a>
            {% else %}
              <a class="nav-more__item" href="{{ '/moments/' | relative_url }}">moments</a>
            {% endif %}
            {% if is_research_index %}
              <span class="nav-more__item is-active" aria-current="page">research</span>
            {% elsif is_research_active %}
              <a class="nav-more__item is-active" href="{{ '/research/' | relative_url }}" aria-current="page">research</a>
            {% else %}
              <a class="nav-more__item" href="{{ '/research/' | relative_url }}">research</a>
            {% endif %}
          </div>
        </div>

        <!-- moments -->
        {% if is_moments_index %}
          <span class="nav-item nav-item--overflow is-active" aria-current="page">moments</span>
        {% elsif is_moments_active %}
          <a class="nav-item nav-item--overflow is-active" href="{{ '/moments/' | relative_url }}" aria-current="page">moments</a>
        {% else %}
          <a class="nav-item nav-item--overflow" href="{{ '/moments/' | relative_url }}">moments</a>
        {% endif %}

        <!-- research -->
        {% if is_research_index %}
          <span class="nav-item nav-item--overflow is-active" aria-current="page">research</span>
        {% elsif is_research_active %}
          <a class="nav-item nav-item--overflow is-active" href="{{ '/research/' | relative_url }}" aria-current="page">research</a>
        {% else %}
          <a class="nav-item nav-item--overflow" href="{{ '/research/' | relative_url }}">research</a>
        {% endif %}
      </nav>
      <script>
        (function () {
          var more = document.querySelector('[data-nav-more]');
          if (!more) return;
          var summary = more.querySelector('.nav-more__summary');
          var panel = more.querySelector('.nav-more__panel');
          if (!summary || !panel) return;

          function closeMenu() {
            more.classList.remove('is-open');
            summary.setAttribute('aria-expanded', 'false');
            panel.setAttribute('hidden', '');
          }

          function openMenu() {
            more.classList.add('is-open');
            summary.setAttribute('aria-expanded', 'true');
            panel.removeAttribute('hidden');
          }

          function toggleMenu() {
            if (more.classList.contains('is-open')) {
              closeMenu();
            } else {
              openMenu();
            }
          }

          // Close when clicking/tapping outside
          function closeIfOutside(e) {
            if (more.contains(e.target)) return;
            closeMenu();
          }
          document.addEventListener('pointerdown', closeIfOutside, true);
          document.addEventListener('touchstart', closeIfOutside, true);
          document.addEventListener('mousedown', closeIfOutside, true);
          document.addEventListener('click', closeIfOutside, true);

          // Close on Escape
          document.addEventListener('keydown', function (e) {
            if (e.key !== 'Escape') return;
            if (!more.classList.contains('is-open')) return;
            closeMenu();
            summary.focus();
          });

          // Close after selecting an item
          more.addEventListener('click', function (e) {
            var t = e.target;
            if (!t) return;
            if (t.tagName && t.tagName.toLowerCase() === 'a') {
              closeMenu();
            }
          });

          summary.addEventListener('click', function (e) {
            e.preventDefault();
            toggleMenu();
          });
        })();
      </script>
    </div>
  </header>

  <main class="container">
    {{ content }}
  </main>

  <footer class="site-footer">
    <div class="container">
      <span class="muted">© {{ site.time | date: "%Y" }} {{ site.title }} · <a href="{{ '/about/' | relative_url }}">about</a></span>
      <button class="theme-toggle" type="button" id="themeToggle" aria-label="Toggle theme">appearance: auto</button>
    </div>
  </footer>

  <script>
    (function () {
      var btn = document.getElementById('themeToggle');
      if (!btn) return;

      function getTheme() {
        return document.documentElement.getAttribute('data-theme') || 'auto';
      }

      function setTheme(t) {
        document.documentElement.setAttribute('data-theme', t);
        try {
          if (t === 'auto') localStorage.removeItem('theme');
          else localStorage.setItem('theme', t);
        } catch (e) {}
        // btn.textContent = 'appearance: ' + t;
        btn.textContent = t;
      }

      function nextTheme(t) {
        if (t === 'auto') return 'light';
        if (t === 'light') return 'dark';
        return 'auto';
      }

      setTheme(getTheme());

      btn.addEventListener('click', function () {
        setTheme(nextTheme(getTheme()));
      });
    })();
  </script>
</body>
</html>
