---
layout: default
---

{% assign detail_uid = page.detail_uid | default: page.slug %}
{% assign title_txt = page.title | default: "" | strip %}
{% assign fallback_work_id = page.work_id | default: "" %}
{% assign fallback_section = page.project_subfolder | default: "details" | slugify %}
{% assign fallback_work_doc = site.works | where: "work_id", fallback_work_id | first %}
{% assign fallback_work_title = fallback_work_doc.title | default: fallback_work_id %}

{% assign media_base = site.media_base | default: "" %}
{% assign media_prefix = site.media_prefix | default: "/assets" %}
{% assign details_img_prefix = media_prefix | append: "/work_details/img" %}
{% assign img_base = media_base | append: details_img_prefix | append: "/" %}

{%- assign src800  = img_base | append: detail_uid | append: "-primary-800.webp" -%}
{%- assign src1200 = img_base | append: detail_uid | append: "-primary-1200.webp" -%}
{%- assign src1600 = img_base | append: detail_uid | append: "-primary-1600.webp" -%}
{%- assign src2400 = img_base | append: detail_uid | append: "-primary-2400.webp" -%}
{%- assign src2400_path = "/assets/work_details/img/" | append: detail_uid | append: "-primary-2400.webp" -%}
{%- assign has_local_2400 = false -%}
{%- assign maybe_2400 = site.static_files | where: "path", src2400_path | first -%}
{%- if maybe_2400 -%}
  {%- assign has_local_2400 = true -%}
{%- endif -%}
{%- assign has_2400 = has_local_2400 -%}
{%- if page.has_primary_2400 == true -%}
  {%- assign has_2400 = true -%}
{%- endif -%}
{%- assign full_src = src1600 -%}
{%- if has_2400 -%}
  {%- assign full_src = src2400 -%}
{%- endif -%}

{%- unless img_base contains '://' -%}
  {%- assign src800  = src800  | relative_url -%}
  {%- assign src1200 = src1200 | relative_url -%}
  {%- assign src1600 = src1600 | relative_url -%}
  {%- assign src2400 = src2400 | relative_url -%}
{%- endunless -%}

<article class="page work">
  <h1 class="visually-hidden">{% if title_txt != "" %}{{ title_txt }}{% else %}Untitled{% endif %}</h1>

  <nav class="seriesNav" id="detailNav"
      aria-label="Detail navigation"
      data-detail-uid="{{ detail_uid | escape }}"
      data-work-id="{{ fallback_work_id | escape }}"
      data-work-title="{{ fallback_work_title | escape }}"
      data-baseurl="{{ site.baseurl | default: '' }}"
      data-default-section="{{ fallback_section | escape }}"
      hidden>
    <a class="seriesNav__prev" id="detailNavPrev" href="#">←</a>
    <a class="seriesNav__next" id="detailNavNext" href="#">→</a>
  </nav>

  <figure class="page__media">
    <a
      class="page__mediaLink"
      href="{{ full_src }}"
      target="_blank"
      rel="noopener"
      style="--work-ar: {{ page.width_px | default: 4 }} / {{ page.height_px | default: 3 }};">
      <img
        class="page__mediaImg"
        src="{{ src1600 }}"
        srcset="
          {{ src800 }} 800w,
          {{ src1200 }} 1200w,
          {{ src1600 }} 1600w{% if has_2400 %},
          {{ src2400 }} 2400w{% endif %}"
        sizes="(max-width: 800px) 100vw, 72ch"
        alt="{{ title_txt | default: detail_uid | escape }}"
        loading="eager"
        fetchpriority="high"
        decoding="async"
        style="width:100%;height:auto;display:block;">
    </a>
  </figure>

  <section class="page__meta page__media">
    <h2 class="visually-hidden">work detail metadata</h2>
    <div class="page__caption">
      <div class="page__row work__titleRow">{% if title_txt != "" %}{{ title_txt }}{% else %}Untitled{% endif %}</div>
      <div class="page__row">cat. {{ detail_uid }}</div>
    </div>
  </section>

  <nav class="page__nav">
    <a
      id="detailBackLink"
      class="page__back"
      href="{{ '/works/' | append: fallback_work_id | append: '/' | relative_url }}#details-{{ fallback_section }}"
      data-baseurl="{{ site.baseurl | default: '' }}"
      data-fallback-work-id="{{ fallback_work_id | escape }}"
      data-fallback-work-title="{{ fallback_work_title | escape }}"
      data-fallback-section="{{ fallback_section | escape }}"
    >← work</a>
  </nav>
</article>

<script>
  (function () {
    var link = document.getElementById('detailBackLink');
    if (!link) return;

    var baseurl = String(link.getAttribute('data-baseurl') || '').replace(/\/$/, '');
    var fallbackWorkId = String(link.getAttribute('data-fallback-work-id') || '').trim();
    var fallbackWorkTitle = String(link.getAttribute('data-fallback-work-title') || '').trim();
    var fallbackSection = String(link.getAttribute('data-fallback-section') || '').trim();
    var params = new URLSearchParams(window.location.search);

    var fromWork = (params.get('from_work') || fallbackWorkId || '').trim();
    var fromWorkTitle = (params.get('from_work_title') || fallbackWorkTitle || fromWork).trim();
    var section = (params.get('section') || fallbackSection || '').trim();

    if (!fromWork) {
      link.textContent = '← works';
      link.setAttribute('href', baseurl + '/series/');
      return;
    }

    var href = baseurl + '/works/' + encodeURIComponent(fromWork) + '/';
    if (section) {
      href += '#details-' + encodeURIComponent(section);
    }
    link.textContent = '← ' + fromWorkTitle;
    link.setAttribute('href', href);
  })();
</script>
<script>
  (function () {
    var nav = document.getElementById('detailNav');
    if (!nav) return;
    var prevA = document.getElementById('detailNavPrev');
    var nextA = document.getElementById('detailNavNext');
    if (!prevA || !nextA) return;

    var baseurl = String(nav.getAttribute('data-baseurl') || '').replace(/\/$/, '');
    var detailUid = String(nav.getAttribute('data-detail-uid') || '').trim();
    var fallbackWorkId = String(nav.getAttribute('data-work-id') || '').trim();
    var fallbackWorkTitle = String(nav.getAttribute('data-work-title') || '').trim();
    var fallbackSection = String(nav.getAttribute('data-default-section') || '').trim();

    var params = new URLSearchParams(window.location.search);
    var fromWork = (params.get('from_work') || fallbackWorkId).trim();
    var fromWorkTitle = (params.get('from_work_title') || fallbackWorkTitle || fromWork).trim();
    var section = (params.get('section') || fallbackSection).trim();
    if (!fromWork) return;

    var jsonUrl = baseurl + '/assets/works/index/' + encodeURIComponent(fromWork) + '.json';

    function buildHref(uid) {
      var href = baseurl + '/work_details/' + encodeURIComponent(uid) + '/?from_work=' + encodeURIComponent(fromWork);
      if (fromWorkTitle) href += '&from_work_title=' + encodeURIComponent(fromWorkTitle);
      if (section) href += '&section=' + encodeURIComponent(section);
      return href;
    }

    fetch(jsonUrl, { cache: 'default' })
      .then(function (r) {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
      })
      .then(function (data) {
        var sections = (data && Array.isArray(data.sections)) ? data.sections : [];
        if (!sections.length) return;

        var details = [];
        if (section) {
          for (var i = 0; i < sections.length; i += 1) {
            var sec = sections[i] || {};
            var subfolder = String(sec.project_subfolder || '')
              .toLowerCase()
              .replace(/[^a-z0-9]+/g, '-')
              .replace(/^-+|-+$/g, '');
            if (subfolder === section) {
              details = Array.isArray(sec.details) ? sec.details : [];
              break;
            }
          }
        }

        // Fallback: if section is missing/unmatched, cycle through all details.
        if (!details.length) {
          for (var s = 0; s < sections.length; s += 1) {
            var secAll = sections[s] || {};
            var list = Array.isArray(secAll.details) ? secAll.details : [];
            for (var d = 0; d < list.length; d += 1) details.push(list[d]);
          }
        }

        var ids = details
          .map(function (d) { return d && d.detail_uid ? String(d.detail_uid) : ''; })
          .filter(Boolean);

        if (ids.length < 2) return;
        var idx = ids.indexOf(detailUid);
        if (idx === -1) return;

        var prevId = ids[(idx - 1 + ids.length) % ids.length];
        var nextId = ids[(idx + 1) % ids.length];
        prevA.href = buildHref(prevId);
        nextA.href = buildHref(nextId);
        nav.hidden = false;
      })
      .catch(function () {
        nav.hidden = true;
      });
  })();
</script>
